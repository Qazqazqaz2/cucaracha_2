<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON –û–±–º–µ–Ω–Ω–∏–∫ & –û—Ä–¥–µ—Ä–∞</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #0088cc; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #006699; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #wallet { margin: 15px 0; padding: 15px; background: #e8f5e8; border-radius: 5px; border: 1px solid #4caf50; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .loading { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .hidden { display: none; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .balance { color: #666; font-size: 0.9em; }
        .slippage-control { display: flex; gap: 10px; margin: 10px 0; }
        .slippage-btn { flex: 1; padding: 8px; text-align: center; background: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .slippage-btn.active { background: #0088cc; color: white; border-color: #0088cc; }
        .slippage-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .quote-info { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #0088cc; }
        .min-received { color: #666; font-size: 0.9em; margin-top: 5px; }
       
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤ */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #0088cc; color: white; border-color: #ddd; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
       
        .order-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .order-form .full-width { grid-column: 1 / -1; }
       
        .orders-list { margin-top: 20px; }
        .order-item { padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .order-item.long { border-left: 4px solid #4caf50; }
        .order-item.short { border-left: 4px solid #f44336; }
        .order-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .order-type { font-weight: bold; padding: 2px 8px; border-radius: 3px; color: white; }
        .order-type.long { background: #4caf50; }
        .order-type.short { background: #f44336; }
        .order-status { padding: 2px 8px; border-radius: 3px; font-size: 0.8em; }
        .order-status.active { background: #ff9800; color: white; }
        .order-status.executed { background: #4caf50; color: white; }
        .order-status.cancelled { background: #9e9e9e; color: white; }
        .order-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; }
        .order-actions { margin-top: 10px; text-align: right; }
        .cancel-btn { background: #f44336; padding: 5px 10px; font-size: 0.8em; width: auto; }
       
        .wallet-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em; }
        .deposit-btn {
            background: #4caf50;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            margin-right: 5px;
        }
        .deposit-btn:hover {
            background: #45a049;
        }
        .order-actions {
            margin-top: 10px;
            text-align: right;
        }
        .cancel-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
        }
        .edit-btn {
            background: #ff9800;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background: #e65100;
        }
        .cancel-btn:hover {
            background: #d32f2f;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤ –≤ —Å—Ç–∏–ª–µ Bitget */
        .orders-container {
            margin-top: 20px;
        }
       
        .orders-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
       
        .orders-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid transparent;
        }
       
        .orders-tab.active {
            color: #0088cc;
            border-bottom: 2px solid #0088cc;
        }
       
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
       
        .orders-table th {
            text-align: left;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            color: #333;
        }
        
        .order-tab-content {
            padding: 15px 0;
        }
        
        .order-badge {
            display: inline-block;
            font-size: 0.7em;
            margin-left: 5px;
            padding: 2px 5px;
            background: #2196f3;
            color: white;
            border-radius: 3px;
        }
       
        .orders-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .orders-overview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0 25px;
            align-items: stretch;
        }

        .orders-overview-card {
            flex: 1 1 220px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .orders-overview-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 6px;
        }

        .orders-overview-price {
            font-size: 1.8em;
            font-weight: 600;
            color: #0088cc;
        }

        .orders-overview-updated {
            font-size: 0.8em;
            color: #999;
            margin-top: 6px;
        }

        .orders-overview-chart {
            flex: 2 1 320px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 10px;
        }

        #ordersPriceChart {
            width: 100%;
            min-height: 220px;
        }
       
        .orders-table tr:hover {
            background: #f5f5f5;
        }
       
        .side-long {
            color: #4caf50;
            font-weight: bold;
        }
       
        .side-short {
            color: #f44336;
            font-weight: bold;
        }
       
        .status-active, .status-unfunded, .status-waiting_entry {
            color: #ff9800;
            font-weight: bold;
        }
        
        .status-opened {
            color: #2196f3;
            font-weight: bold;
        }
        
        .status-executed {
            color: #4caf50;
            font-weight: bold;
        }
        
        .status-cancelled {
            color: #9e9e9e;
            font-weight: bold;
        }
       
        .pnl-positive {
            color: #4caf50;
        }
       
        .pnl-negative {
            color: #f44336;
        }
       
        .order-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }
       
        .edit-btn {
            background: #ff9800;
            color: white;
        }
       
        .cancel-btn {
            background: #f44336;
            color: white;
        }
       
        .deposit-btn {
            background: #4caf50;
            color: white;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
        .price-chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .chart-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .chart-time-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.75em;
            min-width: 40px;
            text-align: center;
        }
        
        .chart-time-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }
        
        .chart-time-btn:hover {
            background: #e0e0e0;
        }
        
        .chart-time-btn.active:hover {
            background: #006699;
        }
        
        #priceChart {
            max-height: 400px;
        }
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ */
        .order-type-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .order-type-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            background: #f5f5f5;
        }
        
        .order-type-tab.active {
            background: #0088cc;
            color: white;
            border-color: #ddd;
        }
        
        .order-form-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .order-form-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ TON –û–±–º–µ–Ω–Ω–∏–∫ & –¢–æ—Ä–≥–æ–≤—ã–µ –û—Ä–¥–µ—Ä–∞</h1>
       
        <div class="tabs">
            <div class="tab active" data-tab="swap">üîÑ –û–±–º–µ–Ω</div>
            <div class="tab" data-tab="orders">üìä –û—Ä–¥–µ—Ä–∞</div>
            <div class="tab" data-tab="wallet">üëõ –ö–æ—à–µ–ª–µ–∫ –æ—Ä–¥–µ—Ä–æ–≤</div>
        </div>
       
        <div id="wallet" class="hidden"></div>
        <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
        <!-- –í–∫–ª–∞–¥–∫–∞ –æ–±–º–µ–Ω–∞ -->
        <div class="tab-content active" id="swap-tab">
            <form id="swapForm" class="hidden">
                <div class="form-group">
                    <label>–û—Ç–¥–∞–µ—Ç–µ:</label>
                    <select id="fromToken">
                        <option value="TON">TON</option>
                        <option value="USDT">USDT</option>
                    </select>
                </div>
               
                <div class="form-group">
                    <label>–ü–æ–ª—É—á–∞–µ—Ç–µ:</label>
                    <select id="toToken">
                        <option value="USDT">USDT</option>
                        <option value="TON">TON</option>
                    </select>
                </div>
               
                <div class="form-group">
                    <label>–°—É–º–º–∞:</label>
                    <input type="number" id="amount" placeholder="0.0" step="0.01" min="0">
                    <div id="balance" class="balance"></div>
                </div>
                <div class="form-group">
                    <label>–î–æ–ø—É—Å–∫ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (Slippage):</label>
                    <div class="slippage-control">
                        <div class="slippage-btn" data-slippage="0.5">0.5%</div>
                        <div class="slippage-btn active" data-slippage="1.0">1.0%</div>
                        <div class="slippage-btn" data-slippage="2.0">2.0%</div>
                        <div class="slippage-btn" data-slippage="3.0">3.0%</div>
                        <input type="number" id="customSlippage" class="slippage-input" placeholder="Custom" min="0.1" max="50" step="0.1">
                    </div>
                    <div class="balance">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±—É–¥–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç</div>
                </div>
               
                <button type="button" id="getQuote">üìä –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å</button>
                <div id="quote"></div>
                <div id="currentPrice" class="quote-info" style="margin-top: 10px; display: none;">
                    <strong>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å TON/USDT: <span id="priceValue">-</span> USDT</strong>
                </div>
                <button type="submit" id="swapBtn">üîÑ –û–±–º–µ–Ω—è—Ç—å</button>
            </form>
            
            <!-- –ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã -->
            <div class="price-chart-container">
                <h3>üìà –ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã TON-USDT</h3>
                <div class="chart-controls">
                    <button class="chart-time-btn active" data-minutes="0.5">30—Å</button>
                    <button class="chart-time-btn" data-minutes="1">1–º</button>
                    <button class="chart-time-btn" data-minutes="5">5–º</button>
                    <button class="chart-time-btn" data-minutes="15">15–º</button>
                    <button class="chart-time-btn" data-minutes="30">30–º</button>
                    <button class="chart-time-btn" data-hours="1">1—á</button>
                    <button class="chart-time-btn" data-hours="6">6—á</button>
                    <button class="chart-time-btn" data-hours="24">24—á</button>
                    <button class="chart-time-btn" data-hours="168">7–¥</button>
                </div>
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        <!-- –í–∫–ª–∞–¥–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ -->
        <div class="tab-content" id="orders-tab">
            <div class="hidden" id="ordersAuth">
                <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Ä–¥–µ—Ä–∞–º–∏</p>
            </div>
            <div class="hidden" id="ordersInterface">
                <!-- –í–∫–ª–∞–¥–∫–∏ —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤ -->
                <div class="order-type-tabs">
                    <div class="order-type-tab active" data-order-type="simple">üìä –ü—Ä–æ—Å—Ç–æ–π –æ—Ä–¥–µ—Ä</div>
                    <div class="order-type-tab" data-order-type="advanced">‚öôÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π</div>
                    <div class="order-type-tab" data-order-type="oco">üîó OCO –æ—Ä–¥–µ—Ä</div>
                </div>

                <div class="orders-overview">
                    <div class="orders-overview-card">
                        <div class="orders-overview-label">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å TON/USDT</div>
                        <div class="orders-overview-price" id="ordersPriceValue">--</div>
                        <div class="orders-overview-updated" id="ordersPriceUpdated">‚Äî</div>
                    </div>
                    <div class="orders-overview-chart">
                        <canvas id="ordersPriceChart"></canvas>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ (—Å—Ç–∞—Ä–∞—è, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) -->
                <div id="simple-order-form" class="order-tab-content active">
                    <h3>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –æ—Ä–¥–µ—Ä</h3>
                    <form id="orderForm">
                        <div class="order-form">
                            <div class="form-group">
                                <label>–¢–∏–ø –æ—Ä–¥–µ—Ä–∞:</label>
                                <select id="orderType" required>
                                    <option value="long">LONG (–ü–æ–∫—É–ø–∫–∞)</option>
                                    <option value="short">SHORT (–ü—Ä–æ–¥–∞–∂–∞)</option>
                                </select>
                            </div>
                           
                            <div class="form-group">
                                <label>–ü–∞—Ä–∞:</label>
                                <select id="orderPair" required>
                                    <option value="TON-USDT">TON-USDT</option>
                                </select>
                            </div>
                        <div class="form-group full-width">
                            <label>–ö–æ—à–µ–ª—ë–∫ –¥–ª—è –æ—Ä–¥–µ—Ä–∞:</label>
                            <select id="orderWalletSelect">
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                            </select>
                            <div id="walletSelectHint" class="balance"></div>
                        </div>
                           
                            <div class="form-group full-width">
                                <label>–°—É–º–º–∞ (TON):</label>
                                <input type="number" id="orderAmount" placeholder="0.0" step="0.01" min="0.1" required>
                            </div>
                           <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ -->
                            <div id="orderFeeInfo" class="quote-info" style="display: none; margin-top: 15px;">
                                <h4>üí∏ –ö–æ–º–∏—Å—Å–∏–∏ –∏ —Ä–∞—Å—Ö–æ–¥—ã</h4>
                                <div class="fee-details">
                                    <div class="fee-item">
                                        <span>–ö–æ–º–∏—Å—Å–∏—è –æ–±–º–µ–Ω–Ω–∏–∫–∞:</span>
                                        <span id="exchangeFee">-</span>
                                    </div>
                                    <div class="fee-item">
                                        <span>–°–µ—Ç–µ–≤–∞—è –∫–æ–º–∏—Å—Å–∏—è (–≥–∞–∑):</span>
                                        <span id="gasFee">-</span>
                                    </div>
                                    <div class="fee-item total">
                                        <span><strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong></span>
                                        <span id="totalCost">-</span>
                                    </div>
                                    <div class="fee-item">
                                        <span>–ß–∏—Å—Ç–∞—è —Å—É–º–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:</span>
                                        <span id="netAmount">-</span>
                                    </div>
                                </div>
                            </div>

                            <style>
                            .fee-item {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 5px;
                                font-size: 0.9em;
                            }
                            .fee-item.total {
                                border-top: 1px solid #ddd;
                                padding-top: 5px;
                                margin-top: 5px;
                                font-weight: bold;
                            }
                            </style>

                            <script>
                            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π
                            function calculateOrderFees(orderAmount, fromToken) {
                                const exchangeFeePercent = 0.55; // 0.55% –∫–æ–º–∏—Å—Å–∏—è –æ–±–º–µ–Ω–Ω–∏–∫–∞
                                const exchangeFee = orderAmount * (exchangeFeePercent / 100);

                                // –ì–∞–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                                let gasFee;
                                gasFee = 0;

                                const totalCost = fromToken === 'TON' ? 
                                    (parseFloat(orderAmount) + gasFee).toFixed(6) + ' TON' : 
                                    `${orderAmount} ${fromToken} + ${gasFee.toFixed(6)} TON`;

                                const netAmount = (orderAmount - exchangeFee).toFixed(6);

                                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                                document.getElementById('exchangeFee').textContent = `${exchangeFee.toFixed(6)} ${fromToken} (${exchangeFeePercent}%)`;
                                document.getElementById('gasFee').textContent = `${gasFee.toFixed(6)} TON`;
                                document.getElementById('totalCost').textContent = totalCost;
                                document.getElementById('netAmount').textContent = `${netAmount} ${fromToken}`;

                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
                                document.getElementById('orderFeeInfo').style.display = 'block';
                            }

                            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É–º–º—ã
                            document.getElementById('orderAmount').addEventListener('input', function() {
                                const amount = this.value;
                                const fromToken = document.getElementById('orderType').value === 'long' ? 'USDT' : 'TON';
                                if (amount && amount > 0) {
                                    calculateOrderFees(parseFloat(amount), fromToken);
                                } else {
                                    document.getElementById('orderFeeInfo').style.display = 'none';
                                }
                            });

                            document.getElementById('orderType').addEventListener('change', function() {
                                const amount = document.getElementById('orderAmount').value;
                                const fromToken = this.value === 'long' ? 'USDT' : 'TON';
                                if (amount && amount > 0) {
                                    calculateOrderFees(parseFloat(amount), fromToken);
                                }
                            });

                            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–∞–∑–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞
                            const originalOrderSubmit = document.getElementById('orderForm').onsubmit;
                            document.getElementById('orderForm').onsubmit = async function(e) {
                                e.preventDefault();

                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∏—Å—Å–∏—è—Ö
                                const orderType = document.getElementById('orderType').value;
                                const amount = document.getElementById('orderAmount').value;
                                const fromToken = orderType === 'long' ? 'USDT' : 'TON';

                                if (amount && amount > 0) {
                                    calculateOrderFees(parseFloat(amount), fromToken);
                                }

                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
                                return originalOrderSubmit.call(this, e);
                            };
                            </script>
                            <div class="form-group">
                                <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ (USDT):</label>
                                <input type="number" id="entryPrice" placeholder="7.5" step="0.0001" min="0.0001" required>
                            </div>
                           
                            <div class="form-group">
                                <label>Stop Loss (USDT):</label>
                                <input type="number" id="stopLoss" placeholder="7.0" step="0.0001" min="0.0001">
                            </div>
                           
                            <div class="form-group">
                                <label>Take Profit (USDT):</label>
                                <input type="number" id="takeProfit" placeholder="8.0" step="0.0001" min="0.0001">
                            </div>

                            <div class="form-group">
                                <label>Slippage (%)</label>
                                <input type="number" id="orderSlippage" placeholder="1.0" value="1.0" step="0.1" min="0.1" max="20">
                                <div class="balance">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏</div>
                            </div>
                        </div>
                       
                        <button type="submit" id="createOrderBtn">üìà –°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä</button>
                    </form>
                </div>
                
                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                <div id="advanced-order-form" class="order-tab-content" style="display: none;">
                    <h3>–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ä–¥–µ—Ä</h3>
                    <form id="advancedOrderForm">
                        <div class="order-form">
                            <div class="form-group">
                                <label>–¢–∏–ø –æ—Ä–¥–µ—Ä–∞:</label>
                                <select id="advancedOrderType" required>
                                    <option value="LIMIT">–õ–∏–º–∏—Ç–Ω—ã–π</option>
                                    <option value="MARKET">–†—ã–Ω–æ—á–Ω—ã–π</option>
                                    <option value="STOP_ENTRY">–°—Ç–æ–ø-–≤—Ö–æ–¥</option>
                                    <option value="STOP_LOSS">–°—Ç–æ–ø-–ª–æ—Å—Å</option>
                                    <option value="TAKE_PROFIT">–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç</option>
                                </select>
                            </div>
                           
                            <div class="form-group">
                                <label>–°—Ç–æ—Ä–æ–Ω–∞:</label>
                                <select id="advancedSide" required>
                                    <option value="LONG">LONG</option>
                                    <option value="SHORT">SHORT</option>
                                </select>
                            </div>
                           
                            <div class="form-group">
                                <label>–ü–∞—Ä–∞:</label>
                                <select id="advancedPair" required>
                                    <option value="TON-USDT">TON-USDT</option>
                                </select>
                            </div>
                           
                            <div class="form-group full-width">
                                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                <input type="number" id="advancedQuantity" placeholder="1.0" step="0.01" min="0.1" required>
                            </div>
                           
                            <div class="form-group" id="limitPriceGroup">
                                <label>–õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞ (USDT):</label>
                                <input type="number" id="limitPrice" placeholder="7.5" step="0.01" min="0.01">
                            </div>
                           
                            <div class="form-group" id="stopPriceGroup" style="display: none;">
                                <label>–°—Ç–æ–ø-—Ü–µ–Ω–∞ (USDT):</label>
                                <input type="number" id="stopPrice" placeholder="7.0" step="0.01" min="0.01">
                            </div>
                           
                            <div class="form-group" id="entryPriceGroup">
                                <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ (USDT):</label>
                                <input type="number" id="advancedEntryPrice" placeholder="7.5" step="0.01" min="0.01">
                            </div>
                           
                            <div class="form-group">
                                <label>Stop Loss (USDT):</label>
                                <input type="number" id="advancedStopLoss" placeholder="7.0" step="0.01" min="0.01">
                            </div>
                           
                            <div class="form-group">
                                <label>Take Profit (USDT):</label>
                                <input type="number" id="advancedTakeProfit" placeholder="8.0" step="0.01" min="0.01">
                            </div>
                           
                            <div class="form-group full-width" id="slippageGroup" style="display: none;">
                                <label>–ú–∞–∫—Å. –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (%):</label>
                                <input type="number" id="maxSlippage" placeholder="0.5" step="0.1" min="0.1" max="10" value="0.5">
                            </div>
                           
                            <div class="form-group full-width">
                                <label>
                                    <input type="checkbox" id="enableTrailing"> –í–∫–ª—é—á–∏—Ç—å —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø
                                </label>
                            </div>
                           
                            <div id="trailingConfig" style="display: none;">
                                <div class="form-group">
                                    <label>–¢–∏–ø —Ç—Ä–µ–π–ª–∏–Ω–≥–∞:</label>
                                    <select id="trailingType">
                                        <option value="FIXED">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–ø—É–Ω–∫—Ç—ã)</option>
                                        <option value="PERCENTAGE">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π</option>
                                    </select>
                                </div>
                               
                                <div class="form-group">
                                    <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</label>
                                    <input type="number" id="trailingDistance" placeholder="5.0" step="0.1" min="0.1">
                                </div>
                            </div>
                        </div>
                       
                        <button type="submit" id="createAdvancedOrderBtn">üìà –°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä</button>
                    </form>
                </div>
                
                <!-- OCO —Ñ–æ—Ä–º–∞ -->
                <div id="oco-order-form" class="order-tab-content" style="display: none;">
                    <h3>–°–æ–∑–¥–∞—Ç—å OCO –æ—Ä–¥–µ—Ä (Take Profit / Stop Loss)</h3>
                    <form id="ocoOrderForm">
                        <div class="order-form">
                            <div class="form-group">
                                <label>–°—Ç–æ—Ä–æ–Ω–∞:</label>
                                <select id="ocoSide" required>
                                    <option value="LONG">LONG</option>
                                    <option value="SHORT">SHORT</option>
                                </select>
                            </div>
                           
                            <div class="form-group">
                                <label>–ü–∞—Ä–∞:</label>
                                <select id="ocoPair" required>
                                    <option value="TON-USDT">TON-USDT</option>
                                </select>
                            </div>
                           
                            <div class="form-group full-width">
                                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                <input type="number" id="ocoQuantity" placeholder="1.0" step="0.01" min="0.1" required>
                            </div>
                           
                            <div class="form-group">
                                <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ (USDT):</label>
                                <input type="number" id="ocoEntryPrice" placeholder="7.5" step="0.01" min="0.01" required>
                            </div>
                           
                            <h4 style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">Take Profit</h4>
                           
                            <div class="form-group">
                                <label>TP –¶–µ–Ω–∞ (USDT):</label>
                                <input type="number" id="ocoTakeProfit" placeholder="8.0" step="0.01" min="0.01" required>
                            </div>
                           
                            <h4 style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">Stop Loss</h4>
                           
                            <div class="form-group">
                                <label>SL –¶–µ–Ω–∞ (USDT):</label>
                                <input type="number" id="ocoStopLoss" placeholder="7.0" step="0.01" min="0.01" required>
                            </div>
                        </div>
                       
                        <button type="submit" id="createOcoOrderBtn">üîó –°–æ–∑–¥–∞—Ç—å OCO –æ—Ä–¥–µ—Ä</button>
                    </form>
                </div>
                <div class="orders-list">
                    <div class="orders-tabs">
                        <div class="orders-tab active" data-orders-tab="active">Open Orders</div>
                        <div class="orders-tab" data-orders-tab="history">Order History</div>
                    </div>
               
                    <div id="activeOrders" class="orders-content active">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Pair</th>
                                    <th>Side</th>
                                    <th>Amount (TON)</th>
                                    <th>Entry Price (USDT)</th>
                                    <th>TP (USDT)</th>
                                    <th>SL (USDT)</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeOrdersBody"></tbody>
                        </table>
                    </div>
               
                    <div id="orderHistory" class="orders-content" style="display: none;">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Pair</th>
                                    <th>Side</th>
                                    <th>Amount (TON)</th>
                                    <th>Entry Price (USDT)</th>
                                    <th>Exec Price (USDT)</th>
                                    <th>PNL (USDT)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="orderHistoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ -->
        <div class="tab-content" id="wallet-tab">
            <div class="wallet-info">
                <h3>üëõ –ö–æ—à–µ–ª—å–∫–∏ –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤</h3>
                <div id="orderWalletList"></div>
                <button id="refreshWalletsBtn" style="margin-top:10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
            <div class="form-group">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—à–µ–ª—ë–∫</h4>
                <form id="importWalletForm">
                    <input type="text" id="walletLabel" placeholder="–ú–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <input type="text" id="walletAddressInput" placeholder="–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞" required>
                    <textarea id="walletMnemonicInput" placeholder="–ú–Ω–µ–º–æ–Ω–∏–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
            <div class="form-group">
                <h4>–í—ã–≤–æ–¥ TON</h4>
                <form id="walletTransferForm">
                    <input type="text" id="transferDestination" placeholder="–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è" required>
                    <input type="number" id="transferAmount" placeholder="–°—É–º–º–∞ TON" min="0" step="0.01" required>
                    <input type="text" id="transferComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <button type="submit">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
            <div class="form-group">
                <h4>–û–±–º–µ–Ω –∏–∑ –∫–æ—à–µ–ª—å–∫–∞</h4>
                <form id="walletSwapForm">
                    <select id="walletSwapPair">
                        <option value="TON-USDT">TON ‚Üí USDT</option>
                    </select>
                    <select id="walletSwapSide">
                        <option value="long">–ü–æ–∫—É–ø–∫–∞ (TON‚ÜíUSDT)</option>
                        <option value="short">–ü—Ä–æ–¥–∞–∂–∞ (USDT‚ÜíTON)</option>
                    </select>
                    <input type="number" id="walletSwapAmount" placeholder="–°—É–º–º–∞" min="0" step="0.01" required>
                    <input type="number" id="walletSwapSlippage" placeholder="Slippage %" value="1.0" step="0.1">
                    <button type="submit">üîÅ –û–±–º–µ–Ω—è—Ç—å</button>
                </form>
            </div>
            <div class="form-group">
                <h4>–ü—É–ª—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏</h4>
                <div id="liquidityPoolsList" class="balance"></div>
                <form id="addPoolForm">
                    <input type="text" id="poolPair" placeholder="–ü–∞—Ä–∞ (TON-USDT)" required>
                    <input type="text" id="poolDex" placeholder="DEX (DeDust/StonFi)" required>
                    <input type="text" id="poolAddress" placeholder="–ê–¥—Ä–µ—Å –ø—É–ª–∞" required>
                    <input type="text" id="poolFromToken" placeholder="–ò–∑ —Ç–æ–∫–µ–Ω–∞ (TON)" required>
                    <input type="text" id="poolToToken" placeholder="–í —Ç–æ–∫–µ–Ω (USDT)" required>
                    <input type="text" id="poolFromTokenAddr" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ FROM (–æ–ø—Ü.)">
                    <input type="text" id="poolToTokenAddr" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ TO (–æ–ø—Ü.)">
                    <button type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—É–ª</button>
                </form>
            </div>
        </div>
        <div id="result"></div>
    </div>
    <script>
        let currentWallet = null;
        let tonConnectUI = null;
        let currentSlippage = 1.0;
        let orders = [];
        let priceChart = null;
        let ordersPriceChart = null;
        let priceCharts = [];
        let currentChartPeriod = { type: 'minutes', value: 0.5 }; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥
        let orderWallets = [];
        let selectedOrderWalletId = null;
        let latestMarketPrice = null;
        let orderDefaultsInitialized = false;
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
        function initTonConnect() {
            const manifestUrl = "https://raw.githubusercontent.com/Qazqazqaz2/cucaracha_2/main/tonconnect-manifest.json";
           
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: manifestUrl,
                buttonRootId: 'connectBtn'
            });
            tonConnectUI.connectionRestored.then(() => {
                console.log('Connection restored, checking...');
                checkConnection();
            }).catch(err => {
                console.log('No previous connection:', err);
                checkConnection();
            });
            tonConnectUI.onStatusChange(wallet => {
                console.log('Status changed:', wallet);
                if (wallet) {
                    currentWallet = wallet;
                }
                checkConnection();
            });
        }
       
        function checkConnection() {
            const wallet = tonConnectUI.account;
            if (wallet && wallet.address) {
                currentWallet = wallet;
                const shortAddress = wallet.address.slice(0, 8) + '...' + wallet.address.slice(-8);
                document.getElementById('wallet').innerHTML = `‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω: ${shortAddress}`;
                document.getElementById('wallet').classList.remove('hidden');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('swapForm').classList.remove('hidden');
                document.getElementById('ordersInterface').classList.remove('hidden');
                document.getElementById('ordersAuth').classList.add('hidden');
                updateBalance();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–¥–µ—Ä–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ currentWallet —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                setTimeout(() => {
                    loadOrders();
                }, 100);
                loadOrderWallets();
            } else {
                currentWallet = null;
                document.getElementById('wallet').classList.add('hidden');
                document.getElementById('connectBtn').classList.remove('hidden');
                document.getElementById('swapForm').classList.add('hidden');
                document.getElementById('ordersInterface').classList.add('hidden');
                document.getElementById('ordersAuth').classList.remove('hidden');
                orders = [];
                renderOrders();
                loadOrderWallets();
            }
        }
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                   
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab + '-tab';
                    document.getElementById(tabId).classList.add('active');
                   
                    // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –æ—Ä–¥–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    if (tab.dataset.tab === 'orders') {
                        loadOrders();
                    }
                });
            });
        }
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ slippage
        function setupSlippageControls() {
            const buttons = document.querySelectorAll('.slippage-btn');
            const customInput = document.getElementById('customSlippage');
           
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSlippage = parseFloat(btn.dataset.slippage);
                    customInput.value = '';
                });
            });
           
            customInput.addEventListener('input', () => {
                if (customInput.value) {
                    buttons.forEach(b => b.classList.remove('active'));
                    currentSlippage = parseFloat(customInput.value);
                }
            });
           
            customInput.addEventListener('blur', () => {
                if (customInput.value) {
                    let value = parseFloat(customInput.value);
                    if (value < 0.1) value = 0.1;
                    if (value > 50) value = 50;
                    currentSlippage = value;
                    customInput.value = value;
                }
            });
        }
        async function loadOrders() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º currentWallet –∏ tonConnectUI.account
            const wallet = currentWallet || (tonConnectUI && tonConnectUI.account);
            if (!wallet || !wallet.address) {
                console.warn('–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω, –æ—Ä–¥–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                orders = [];
                renderOrders();
                return;
            }
            
            console.log('Loading orders for wallet:', wallet.address);
        
            try {
                const res = await fetch('/user-orders?user_wallet=' + encodeURIComponent(wallet.address));
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                const data = await res.json();
                console.log('Loaded orders:', data.orders); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                orders = Array.isArray(data.orders) ? data.orders : [];
                renderOrders();
            } catch (error) {
                console.error('Load orders error:', error);
                showResult('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–¥–µ—Ä–æ–≤: ' + error.message, 'error');
                orders = [];
                renderOrders();
            }
        }

        async function loadOrderWallets() {
            if (!currentWallet) {
                orderWallets = [];
                selectedOrderWalletId = null;
                renderOrderWalletSelect();
                renderWalletList();
                return;
            }
            try {
                const res = await fetch('/api/order-wallets?owner_wallet=' + encodeURIComponent(currentWallet.address));
                const data = await res.json();
                orderWallets = Array.isArray(data.wallets) ? data.wallets : [];
                if (orderWallets.length > 0) {
                    selectedOrderWalletId = orderWallets[0].id;
                    renderOrderWalletSelect();
                    renderWalletList();
                    await loadWalletBalances(selectedOrderWalletId);
                } else {
                    selectedOrderWalletId = null;
                    renderOrderWalletSelect();
                    renderWalletList();
                }
            } catch (error) {
                console.error('Load wallets error:', error);
            }
        }

        function renderOrderWalletSelect() {
            const select = document.getElementById('orderWalletSelect');
            const hint = document.getElementById('walletSelectHint');
            if (!select) return;
            select.innerHTML = '';
            if (!orderWallets.length) {
                select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</option>';
                if (hint) hint.textContent = '–î–æ–±–∞–≤—å—Ç–µ –∫–æ—à–µ–ª–µ–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ö–æ—à–µ–ª–µ–∫ –æ—Ä–¥–µ—Ä–æ–≤"';
                return;
            }
            orderWallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.id;
                option.textContent = `${wallet.label || wallet.address.slice(0,6) + '...'}`;
                if (wallet.id === selectedOrderWalletId) option.selected = true;
                select.appendChild(option);
            });
            if (hint) {
                const selected = orderWallets.find(w => w.id === selectedOrderWalletId);
                hint.textContent = selected ? `–í—ã–±—Ä–∞–Ω: ${selected.address}` : '';
            }
        }

        function renderWalletList() {
            const container = document.getElementById('orderWalletList');
            if (!container) return;
            if (!orderWallets.length) {
                container.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤.</p>';
                return;
            }
            container.innerHTML = '';
            orderWallets.forEach(wallet => {
                const div = document.createElement('div');
                div.style.border = '1px solid #ddd';
                div.style.padding = '10px';
                div.style.marginBottom = '10px';
                div.style.borderRadius = '6px';
                div.innerHTML = `
                    <strong>${wallet.label || '–ö–æ—à–µ–ª–µ–∫ #' + wallet.id}</strong><br>
                    <small>${wallet.address}</small><br>
                    <small>${wallet.has_mnemonic ? 'üîê –ú–Ω–µ–º–æ–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' : '‚ö†Ô∏è –ù–µ—Ç –º–Ω–µ–º–æ–Ω–∏–∫–∏'}</small><br>
                    <button data-wallet="${wallet.id}" class="wallet-select-btn">${wallet.id === selectedOrderWalletId ? '‚úîÔ∏è –í—ã–±—Ä–∞–Ω' : '–í—ã–±—Ä–∞—Ç—å'}</button>
                    <button data-balance="${wallet.id}" class="wallet-balance-btn">–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å</button>
                    ${wallet.has_mnemonic ? '' : `<button data-add-mnemonic="${wallet.id}" class="wallet-add-mnemonic-btn">–î–æ–±–∞–≤–∏—Ç—å –º–Ω–µ–º–æ–Ω–∏–∫—É</button>`}
                    <button data-delete-wallet="${wallet.id}" class="wallet-delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                    <div id="walletTokens-${wallet.id}" class="balance"></div>
                `;
                container.appendChild(div);
            });
            document.querySelectorAll('.wallet-select-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedOrderWalletId = parseInt(btn.dataset.wallet);
                    renderOrderWalletSelect();
                    renderWalletList();
                });
            });
            document.querySelectorAll('.wallet-balance-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const wid = parseInt(btn.dataset.balance);
                    loadWalletBalances(wid);
                });
            });
            document.querySelectorAll('.wallet-add-mnemonic-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const wid = parseInt(btn.dataset.addMnemonic);
                    const phrase = prompt('–í–≤–µ–¥–∏—Ç–µ –º–Ω–µ–º–æ–Ω–∏–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞:');
                    if (!phrase) return;
                    try {
                        const res = await fetch(`/api/order-wallets/${wid}/mnemonic`, {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({mnemonic: phrase})
                        });
                        const data = await res.json();
                        if (data.success) {
                            showResult('–ú–Ω–µ–º–æ–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                            loadOrderWallets();
                        } else {
                            showResult('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                        }
                    } catch (error) {
                        showResult('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–Ω–µ–º–æ–Ω–∏–∫–∏', 'error');
                    }
                });
            });
            document.querySelectorAll('.wallet-delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const wid = parseInt(btn.dataset.deleteWallet);
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ—à–µ–ª–µ–∫?')) return;
                    try {
                        const res = await fetch(`/api/order-wallets/${wid}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            showResult('–ö–æ—à–µ–ª–µ–∫ —É–¥–∞–ª–µ–Ω', 'success');
                            if (wid === selectedOrderWalletId) {
                                selectedOrderWalletId = null;
                            }
                            loadOrderWallets();
                        } else {
                            showResult('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                        }
                    } catch (error) {
                        showResult('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞', 'error');
                    }
                });
            });
        }

        async function loadWalletBalances(walletId) {
            try {
                const res = await fetch(`/api/order-wallets/${walletId}/balances`);
                if (!res.ok) return;
                const data = await res.json();
                const container = document.getElementById(`walletTokens-${walletId}`);
                if (!container) return;
                if (!data.tokens || !data.tokens.length) {
                    container.textContent = '–ù–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤';
                    return;
                }
                container.innerHTML = data.tokens.map(t => `${t.symbol}: ${t.balance.toFixed(4)}`).join(' | ');
            } catch (error) {
                console.error('Balances error:', error);
            }
        }

        async function loadPoolsList() {
            const container = document.getElementById('liquidityPoolsList');
            if (!container) return;
            try {
                const res = await fetch('/pools');
                if (!res.ok) {
                    container.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—É–ª–æ–≤';
                    return;
                }
                const data = await res.json();
                const entries = [];
                Object.keys(data).forEach(pair => {
                    const poolList = Array.isArray(data[pair]) ? data[pair] : [data[pair]];
                    poolList.forEach(pool => {
                        entries.push(`${pair} - ${pool.dex}: ${pool.address}`);
                    });
                });
                container.innerHTML = entries.length ? entries.join('<br>') : '–ü—É–ª—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã';
            } catch (error) {
                container.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—É–ª–æ–≤';
            }
        }
        // –°—Ç–∞—Ç—É—Å—ã –æ—Ä–¥–µ—Ä–æ–≤
        function getStatusText(status) {
            const statusMap = {
                'unfunded': 'UNFUNDED',
                'waiting_entry': 'WAITING ENTRY',
                'opened': 'OPENED',
                'active': 'ACTIVE',  // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                'executed': 'EXECUTED',
                'execution_failed': 'EXECUTION FAILED',
                'cancelled': 'CANCELLED'
            };
            return statusMap[status] || status;
        }
        // –í—Å—Ç–∞–≤–∏–º —Ä–∞—Å—á–µ—Ç PnL/–∫–æ–º–∏—Å—Å–∏–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞ –∏ entry_price) –∏ —Ä–∞—Å—à–∏—Ä–∏–º—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–µ—Ç–∞–ª–µ–π:
        function calculatePnL(order, currentPrice) {
            // PNL = (—Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å - entry) * amount –¥–ª—è LONG, –Ω–∞–æ–±–æ—Ä–æ—Ç –¥–ª—è SHORT
            if (!order.entry_price || !order.amount) return 0;
            if (!currentPrice) return 0;
            let pnl = 0;
            if (order.type === 'long') {
                pnl = (currentPrice - order.entry_price) * order.amount;
            } else {
                pnl = (order.entry_price - currentPrice) * order.amount;
            }
            return pnl;
        }
        function calculateComms(order) {
            // –û–±—â–∞—è –∫–æ–º–∏—Å—Å–∏—è = service_fee + pool_fee
            // 0.0025 + 0.003 = 0.0055 (0.55%) –æ—Ç —Å—É–º–º—ã
            return order.amount ? order.amount * 0.0055 : 0;
        }
        // –û—Ç–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞
        async function cancelOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä?')) return;
           
            try {
                const res = await fetch(`/orders/${orderId}`, { method: 'DELETE' });
                const data = await res.json();
               
                if (data.success) {
                    showResult('–û—Ä–¥–µ—Ä –æ—Ç–º–µ–Ω–µ–Ω', 'success');
                    loadOrders();
                } else {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                showResult('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞', 'error');
            }
        }
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                await tonConnectUI.openModal();
            } catch (error) {
                console.error('Connection error:', error);
                showResult('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            }
        });
        async function updateBalance() {
            if (!currentWallet) return;
           
            const walletAddr = currentWallet.address;
            const fromToken = document.getElementById('fromToken').value;
           
            try {
                const res = await fetch('/balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({wallet_address: walletAddr, token: fromToken})
                });
                const data = await res.json();
               
                const balanceDiv = document.getElementById('balance');
                if (data.error) {
                    balanceDiv.innerHTML = `–û—à–∏–±–∫–∞: ${data.error}`;
                } else {
                    balanceDiv.innerHTML = `–ë–∞–ª–∞–Ω—Å: ${data.balance.toFixed(4)} ${fromToken}`;
                }
            } catch (error) {
                console.error('Balance error:', error);
            }
        }
        document.getElementById('getQuote').addEventListener('click', async () => {
            const fromToken = document.getElementById('fromToken').value;
            const toToken = document.getElementById('toToken').value;
            const amount = document.getElementById('amount').value;
            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–±–º–µ–Ω–∞', 'error');
                return;
            }
            try {
                const res = await fetch('/quote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        from_token: fromToken,
                        to_token: toToken,
                        amount: amount,
                        slippage: currentSlippage
                    })
                });
                const data = await res.json();
               
                const quoteDiv = document.getElementById('quote');
                if (data.error) {
                    quoteDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                } else {
                    const alt = (data.alternatives || []).map(q => `${q.dex}: ${q.quote.toFixed(4)}`).join(' | ');
                    quoteDiv.innerHTML = `
                        <div class="quote-info">
                            <strong>–õ—É—á—à–∏–π –∫—É—Ä—Å (${data.dex}): ${data.formatted}</strong>
                            <div class="min-received">–ú–∏–Ω–∏–º—É–º: ${data.min_output_formatted} (slippage: ${data.slippage}%)</div>
                            ${alt ? `<div class="balance">–î—Ä—É–≥–∏–µ –ø—É–ª—ã: ${alt}</div>` : ''}
                        </div>
                    `;
                }
                
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                updateCurrentPrice();
            } catch (error) {
                console.error('Quote error:', error);
                showResult('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞', 'error');
            }
        });
        // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
           
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
            if (!selectedOrderWalletId) {
                showResult('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –æ—Ä–¥–µ—Ä–∞', 'error');
                return;
            }
           
            const orderType = document.getElementById('orderType').value;
            const pair = document.getElementById('orderPair').value;
            const amount = document.getElementById('orderAmount').value;
            const entryPrice = document.getElementById('entryPrice').value;
            const stopLoss = document.getElementById('stopLoss').value;
            const takeProfit = document.getElementById('takeProfit').value;
            const orderSlippageInput = document.getElementById('orderSlippage');
            const orderSlippageValue = orderSlippageInput ? Math.max(0.1, parseFloat(orderSlippageInput.value) || 1) : 1;
           
            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ä–¥–µ—Ä–∞', 'error');
                return;
            }
           
            if (!entryPrice || entryPrice <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞', 'error');
                return;
            }
            try {
                const res = await fetch('/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: orderType,
                        pair: pair,
                        amount: parseFloat(amount),
                        entry_price: parseFloat(entryPrice),
                        stop_loss: stopLoss || null,
                        take_profit: takeProfit || null,
                        user_wallet: currentWallet.address,
                        order_wallet_id: selectedOrderWalletId,
                        slippage: orderSlippageValue
                    })
                });
               
                const data = await res.json();
               
                if (data.success) {
                    let msg = `–û—Ä–¥–µ—Ä ${orderType.toUpperCase()} —Å–æ–∑–¥–∞–Ω!`;
                    if (data.order.status === 'unfunded') {
                        if (data.gas_info) {
                            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∞–∑–µ
                            msg += `<br><b>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <span style='color:#0088cc'>${data.gas_info.total_amount.toFixed(6)} TON</span> –Ω–∞ <span style='color:#006699'>${data.order.order_wallet}</span> –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!</b>`;
                            msg += `<br><small>–í–∫–ª—é—á–∞—è –≥–∞–∑: ${data.gas_info.gas_amount.toFixed(6)} TON</small>`;
                        } else {
                            msg += `<br><b>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <span style='color:#0088cc'>${data.order.amount} TON</span> –Ω–∞ <span style='color:#006699'>${data.order.order_wallet}</span> –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!</b>`;
                        }
                    } else if (data.gas_info) {
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∞–∑–µ –¥–ª—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
                        msg += `<br><small>–ì–∞–∑: ${data.gas_info.gas_amount.toFixed(6)} TON</small>`;
                    }
                    showResult(msg, 'success');
                    document.getElementById('orderForm').reset();
                    loadOrders();
                } else {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Create order error:', error);
                showResult('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞', 'error');
            }
        });
        document.getElementById('swapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
           
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
       
            const fromToken = document.getElementById('fromToken').value;
            const toToken = document.getElementById('toToken').value;
            const amount = document.getElementById('amount').value;
       
            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–±–º–µ–Ω–∞', 'error');
                return;
            }
       
            try {
                showResult('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...', 'loading');
               
                const res = await fetch('/swap', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        wallet_address: currentWallet.address,
                        from_token: fromToken,
                        to_token: toToken,
                        amount: amount,
                        slippage: currentSlippage
                    })
                });
                const data = await res.json();
               
                if (data.error) {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                    return;
                }
           
                showResult('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –∫–æ—à–µ–ª—å–∫–µ...', 'loading');
               
                let message;
                if (data.messages && Array.isArray(data.messages)) {
                    message = data.messages[0];
                } else {
                    message = {
                        address: data.to_address,
                        amount: data.amount,
                        payload: data.payload
                    };
                }
           
                const transaction = {
                    validUntil: data.validUntil || Math.floor(Date.now() / 1000) + 300,
                    messages: [message]
                };
           
                try {
                    const result = await tonConnectUI.sendTransaction(transaction);
                    showResult('–°–≤–æ–ø –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    console.log("Transaction sent:", result);
                   
                    setTimeout(updateBalance, 3000);
                } catch (txError) {
                    console.error("Transaction failed:", txError);
                    if (txError.message?.includes('rejected') || txError.message?.includes('declined')) {
                        showResult('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'error');
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + txError.message, 'error');
                    }
                }
           
            } catch (error) {
                console.error('Swap error:', error);
                showResult('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
   
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = type ? (type === 'success' ? 'success' : type === 'loading' ? 'loading' : 'error') : '';
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–æ–∫–µ–Ω–∞
        document.getElementById('fromToken').addEventListener('change', updateBalance);
        const orderWalletSelect = document.getElementById('orderWalletSelect');
        if (orderWalletSelect) {
            orderWalletSelect.addEventListener('change', (e) => {
                selectedOrderWalletId = parseInt(e.target.value);
                renderWalletList();
            });
        }

        const refreshWalletsBtn = document.getElementById('refreshWalletsBtn');
        if (refreshWalletsBtn) {
            refreshWalletsBtn.addEventListener('click', () => loadOrderWallets());
        }

        const importWalletForm = document.getElementById('importWalletForm');
        if (importWalletForm) {
            importWalletForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentWallet) {
                    showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                    return;
                }
                try {
                    const payload = {
                        owner_wallet: currentWallet.address,
                        label: document.getElementById('walletLabel').value,
                        address: document.getElementById('walletAddressInput').value,
                        mnemonic: document.getElementById('walletMnemonicInput').value
                    };
                    const res = await fetch('/api/order-wallets', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        showResult('–ö–æ—à–µ–ª–µ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                        importWalletForm.reset();
                        loadOrderWallets();
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                    }
                } catch (error) {
                    showResult('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞', 'error');
                }
            });
        }

        const walletTransferForm = document.getElementById('walletTransferForm');
        if (walletTransferForm) {
            walletTransferForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedOrderWalletId) {
                    showResult('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                    return;
                }
                const payload = {
                    destination: document.getElementById('transferDestination').value,
                    amount: document.getElementById('transferAmount').value,
                    comment: document.getElementById('transferComment').value,
                    token: 'TON'
                };
                try {
                    const res = await fetch(`/api/order-wallets/${selectedOrderWalletId}/transfer`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        showResult('–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                        walletTransferForm.reset();
                        loadWalletBalances(selectedOrderWalletId);
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + (data.message || data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                    }
                } catch (error) {
                    showResult('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞', 'error');
                }
            });
        }

        const walletSwapForm = document.getElementById('walletSwapForm');
        if (walletSwapForm) {
            walletSwapForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedOrderWalletId) {
                    showResult('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                    return;
                }
                const payload = {
                    pair: document.getElementById('walletSwapPair').value,
                    type: document.getElementById('walletSwapSide').value,
                    amount: document.getElementById('walletSwapAmount').value,
                    slippage: document.getElementById('walletSwapSlippage').value
                };
                try {
                    const res = await fetch(`/api/order-wallets/${selectedOrderWalletId}/swap`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        showResult('–°–≤–æ–ø –∏–∑ –∫–æ—à–µ–ª—å–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                        loadWalletBalances(selectedOrderWalletId);
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + (data.error || data.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                    }
                } catch (error) {
                    showResult('–û—à–∏–±–∫–∞ —Å–≤–æ–ø–∞', 'error');
                }
            });
        }

        const addPoolForm = document.getElementById('addPoolForm');
        if (addPoolForm) {
            addPoolForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    pair: document.getElementById('poolPair').value,
                    dex: document.getElementById('poolDex').value,
                    address: document.getElementById('poolAddress').value,
                    from_token: document.getElementById('poolFromToken').value,
                    to_token: document.getElementById('poolToToken').value,
                    from_token_address: document.getElementById('poolFromTokenAddr').value || null,
                    to_token_address: document.getElementById('poolToTokenAddr').value || null
                };
                try {
                    const res = await fetch('/api/pools', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        showResult('–ü—É–ª –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                        addPoolForm.reset();
                        loadPoolsList();
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
                    }
                } catch (error) {
                    showResult('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—É–ª–∞', 'error');
                }
            });
        }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ü–µ–Ω—ã
        function createChartInstance(canvasId, labelText) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: labelText,
                        data: [],
                        borderColor: '#0088cc',
                        backgroundColor: 'rgba(0, 136, 204, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return '–¶–µ–Ω–∞: ' + context.parsed.y.toFixed(6) + ' USDT';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(6) + ' USDT';
                                }
                            }
                        },
                        x: {
                            type: 'category',
                            ticks: {
                                maxTicksLimit: 20,
                                autoSkip: true
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function initPriceCharts() {
            priceChart = createChartInstance('priceChart', '–¶–µ–Ω–∞ TON/USDT');
            ordersPriceChart = createChartInstance('ordersPriceChart', 'TON/USDT (–æ—Ä–¥–µ—Ä–∞)');
            priceCharts = [priceChart, ordersPriceChart].filter(Boolean);
            loadPriceHistory(currentChartPeriod);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
        async function loadPriceHistory(period) {
            try {
                let url = '/price-history?pool=TON-USDT';
                if (period.type === 'minutes') {
                    url += `&minutes=${period.value}`;
                } else {
                    url += `&hours=${period.value}`;
                }
                
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                const data = await res.json();
                
                if (data.success && data.data && priceCharts.length) {
                    const labels = data.data.labels || [];
                    const prices = data.data.prices || [];
                    
                    if (labels.length === 0 || prices.length === 0) {
                        console.warn('No price data available');
                        return;
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
                    const formattedLabels = labels.map((label, index) => {
                        try {
                            const date = new Date(label);
                            if (isNaN(date.getTime())) {
                                return `Point ${index + 1}`;
                            }
                            
                            const periodValue = period.type === 'minutes' ? period.value : (period.value * 60);
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
                            if (periodValue <= 1) {
                                // 30 —Å–µ–∫ - 1 –º–∏–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—É–Ω–¥—ã
                                return date.toLocaleTimeString('ru-RU', { 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                            } else if (periodValue <= 30) {
                                // –î–æ 30 –º–∏–Ω—É—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω—É—Ç—ã –∏ —Å–µ–∫—É–Ω–¥—ã
                                return date.toLocaleTimeString('ru-RU', { 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                            } else if (periodValue <= 360) {
                                // –î–æ 6 —á–∞—Å–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
                                return date.toLocaleTimeString('ru-RU', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            } else if (periodValue <= 1440) {
                                // –î–æ 24 —á–∞—Å–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                                return date.toLocaleString('ru-RU', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            } else {
                                // –ë–æ–ª—å—à–µ —Å—É—Ç–æ–∫: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É
                                return date.toLocaleDateString('ru-RU', { 
                                    month: 'short', 
                                    day: 'numeric',
                                    hour: '2-digit'
                                });
                            }
                        } catch (e) {
                            return `Point ${index + 1}`;
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º labels –∏ –¥–∞–Ω–Ω—ã–µ - –≤–∞–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç labels
                    priceCharts.forEach(chart => {
                        if (!chart) return;
                        if (formattedLabels.length === prices.length) {
                            chart.data.labels = formattedLabels;
                            chart.data.datasets[0].data = prices;
                        } else {
                            console.warn('Labels and prices length mismatch:', formattedLabels.length, prices.length);
                            chart.data.labels = formattedLabels;
                            chart.data.datasets[0].data = prices.slice(0, formattedLabels.length);
                        }
                        chart.update('none');
                    });
                }
            } catch (error) {
                console.error('Load price history error:', error);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        function setupChartControls() {
            document.querySelectorAll('.chart-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–µ—Ä–∏–æ–¥–∞
                    if (this.dataset.minutes) {
                        currentChartPeriod = { type: 'minutes', value: parseFloat(this.dataset.minutes) };
                    } else if (this.dataset.hours) {
                        currentChartPeriod = { type: 'hours', value: parseInt(this.dataset.hours) };
                    }
                    
                    loadPriceHistory(currentChartPeriod);
                });
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initTonConnect();
        setupSlippageControls();
        setupTabs();
        initPriceCharts();
        setupChartControls();
        loadPoolsList();
        loadOrderWallets();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentWallet) {
                loadOrders();
                loadOrderWallets();
            }
        }, 30000);
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
        async function updateCurrentPrice() {
            try {
                const res = await fetch('/current-price?pool=TON-USDT');
                if (!res.ok) return;
                
                const data = await res.json();
                if (data.success && data.price) {
                    latestMarketPrice = data.price;
                    const priceElement = document.getElementById('priceValue');
                    const priceContainer = document.getElementById('currentPrice');
                    const ordersPriceElement = document.getElementById('ordersPriceValue');
                    const ordersPriceUpdatedEl = document.getElementById('ordersPriceUpdated');
                    const bestQuote = (data.quotes || []).reduce((best, quote) => {
                        if (!quote || typeof quote.price !== 'number') return best;
                        if (!best || quote.price > best.price) return quote;
                        return best;
                    }, null);
                    if (priceElement && priceContainer) {
                        const priceText = `${data.price.toFixed(4)}${bestQuote ? ' (' + bestQuote.dex + ')' : ''}`;
                        priceElement.textContent = priceText;
                        priceContainer.style.display = 'block';
                    }
                    if (ordersPriceElement) {
                        ordersPriceElement.textContent = `${data.price.toFixed(4)} USDT${bestQuote ? ' ¬∑ ' + bestQuote.dex : ''}`;
                    }
                    if (ordersPriceUpdatedEl) {
                        ordersPriceUpdatedEl.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit', second: '2-digit'})}`;
                    }
                    if (!orderDefaultsInitialized && typeof window.setOrderDefaultsFromPrice === 'function') {
                        window.setOrderDefaultsFromPrice(latestMarketPrice);
                        orderDefaultsInitialized = true;
                    }
                }
            } catch (error) {
                console.error('Update current price error:', error);
            }
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ü–µ–Ω—ã –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(() => {
            loadPriceHistory(currentChartPeriod);
            updateCurrentPrice();
        }, 2000);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateCurrentPrice();
        function bindEditBtns() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = () => {
                    const order = JSON.parse(btn.dataset.order);
                    showEditModal(order);
                }
            });
        }
        window.showEditModal = function(order) {
            if (document.getElementById('orderEditModal')) document.getElementById('orderEditModal').remove();
            const modal = document.createElement('div');
            modal.id = 'orderEditModal';
            modal.style = 'position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `<div style='background:white;padding:30px 20px;border-radius:8px;min-width:320px;max-width:95vw'>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–¥–µ—Ä (${order.id})</h3>
            <form id='editOrderForm'>
              <label>–°—É–º–º–∞ TON:<input type='number' name='amount' value='${order.amount}' step='0.01' required></label><br><label>Stop Loss:<input type='number' name='stop_loss' value='${order.stop_loss || ''}' step='0.01'></label><br><label>Take Profit:<input type='number' name='take_profit' value='${order.take_profit || ''}' step='0.01'></label><br><button type='submit'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button type='button' onclick='document.getElementById("orderEditModal").remove()'>–û—Ç–º–µ–Ω–∞</button>
            </form>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('editOrderForm').onsubmit = async (e) => {
              e.preventDefault();
              const f = e.target;
              const patch = {
                amount: parseFloat(f.amount.value),
                stop_loss: f.stop_loss.value ? parseFloat(f.stop_loss.value) : null,
                take_profit: f.take_profit.value ? parseFloat(f.take_profit.value) : null
              };
              try {
                const res = await fetch(`/orders/${order.id}`, {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(patch)});
                const data = await res.json();
                if (data.success) {
                  showResult('–û—Ä–¥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
                  document.getElementById('orderEditModal').remove();
                  loadOrders();
                } else {
                  showResult('–û—à–∏–±–∫–∞: '+data.error,'error');
                }
              } catch(e){
                showResult('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏','error');
              }
            }
        }
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤
        document.querySelectorAll('.orders-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.orders-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.orders-content').forEach(c => c.style.display = 'none');
                
                // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const tabName = this.dataset.ordersTab;
                let targetId;
                if (tabName === 'active') {
                    targetId = 'activeOrders';
                } else if (tabName === 'history') {
                    targetId = 'orderHistory';
                }
                
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.style.display = 'block';
                } else {
                    console.error(`Element with id "${targetId}" not found`);
                }
            });
        });
        // –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ—Ä–¥–µ—Ä–æ–≤
        function renderOrders() {
            console.log('Total orders to render:', orders.length);

            const activeBody = document.getElementById('activeOrdersBody');
            const historyBody = document.getElementById('orderHistoryBody');
            activeBody.innerHTML = '';
            historyBody.innerHTML = '';

            const formatAmount = (value) => {
                if (value === null || value === undefined || value === '') return '0.00';
                const num = Number(value);
                return isNaN(num) ? '0.00' : num.toFixed(2);
            };

            const formatPrice = (value) => {
                if (value === null || value === undefined || value === '') return '-';
                const num = Number(value);
                return isNaN(num) ? '-' : num.toFixed(4);
            };
                
            console.log('Rendering orders:', orders); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
            // –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ - unfunded, waiting_entry, opened (–Ω–µ executed, –Ω–µ cancelled)
            const activeOrders = orders.filter(o => {
                const status = o.status;
                return status === 'unfunded' || status === 'waiting_entry' || status === 'opened' || status === 'active';
            });
            
            // –ò—Å—Ç–æ—Ä–∏—è - executed, execution_failed –∏ cancelled
            const historyOrders = orders.filter(o => {
                const status = o.status;
                const isHistory = status === 'executed' || status === 'execution_failed' || status === 'cancelled';
                if (!isHistory && (o.executed_at || o.cancelled_at)) {
                    // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ä–¥–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç executed_at –∏–ª–∏ cancelled_at, –Ω–æ —Å—Ç–∞—Ç—É—Å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
                    console.warn('Order with wrong status in history filter:', {
                        id: o.id,
                        status: status,
                        executed_at: o.executed_at,
                        cancelled_at: o.cancelled_at
                    });
                }
                return isHistory;
            });
                
            console.log('Active orders:', activeOrders.length, activeOrders); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('History orders:', historyOrders.length, historyOrders); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
            activeOrders.forEach(order => {
                const row = document.createElement('tr');
                const sideClass = order.type === 'long' ? 'side-long' : 'side-short';
                const statusClass = `status-${order.status}`;
                const date = new Date(order.created_at).toLocaleString();
            
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${order.pair}</td>
                    <td class="${sideClass}">${order.type.toUpperCase()}</td>
                    <td>${formatAmount(order.amount)}</td>
                    <td>${formatPrice(order.entry_price)}</td>
                    <td>${formatPrice(order.take_profit)}</td>
                    <td>${formatPrice(order.stop_loss)}</td>
                    <td class="${statusClass}">${getStatusText(order.status)}</td>
                    <td class="order-actions">
                        ${order.status === 'unfunded' ? 
                            `<button class="deposit-btn" onclick="depositOrder('${order.id}')">Deposit</button>` : ''}
                        ${(order.status === 'unfunded' || order.status === 'waiting_entry' || order.status === 'opened' || order.status === 'active') ? 
                            `<button class="edit-btn" onclick="editOrder('${order.id}')">Edit</button>` : ''}
                        ${(order.status === 'unfunded' || order.status === 'waiting_entry' || order.status === 'opened' || order.status === 'active') ? 
                            `<button class="cancel-btn" onclick="cancelOrder('${order.id}')">Cancel</button>` : ''}
                    </td>
                `;
                activeBody.appendChild(row);
            });
        
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ä–¥–µ—Ä–æ–≤
            historyOrders.forEach(order => {
                const row = document.createElement('tr');
                const sideClass = order.type === 'long' ? 'side-long' : 'side-short';
                const statusClass = `status-${order.status}`;
                const pnlValue = order.pnl != null ? parseFloat(order.pnl) : 0;
                const pnlClass = pnlValue > 0 ? 'pnl-positive' : (pnlValue < 0 ? 'pnl-negative' : '');
                const date = new Date(order.created_at).toLocaleString();
                const execDate = order.executed_at ? new Date(order.executed_at).toLocaleString() : '-';
                
                // –î–ª—è execution_failed –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                const statusText = getStatusText(order.status);
                const errorInfo = order.status === 'execution_failed' && order.execution_error ? 
                    ` (${order.execution_error})` : '';
            
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${order.pair}</td>
                    <td class="${sideClass}">${order.type.toUpperCase()}</td>
                    <td>${formatAmount(order.amount)}</td>
                    <td>${formatPrice(order.entry_price)}</td>
                    <td>${formatPrice(order.execution_price)}</td>
                    <td class="${pnlClass}">${pnlValue.toFixed(2)}</td>
                    <td class="${statusClass}">${statusText}${errorInfo} ${order.execution_type ? `(${order.execution_type})` : ''}</td>
                `;
                historyBody.appendChild(row);
            });
        
            if (activeOrders.length === 0) {
                activeBody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">No open orders</td></tr>';
            }
            if (historyOrders.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">No order history</td></tr>';
            }
        }

        async function editOrder(orderId) {
            // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–¥–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const order = orders.find(o => o.id === orderId);
            if (order) {
                showEditModal(order);
            }
        }
        async function depositOrder(orderId) {
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
       
            try {
                showResult('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è...', 'loading');
                const res = await fetch('/deposit-order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        order_id: orderId
                    })
                });
                const data = await res.json();
                if (data.error) {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                    return;
                }
                showResult('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –∫–æ—à–µ–ª—å–∫–µ...', 'loading');
                try {
                    const result = await tonConnectUI.sendTransaction({
                        validUntil: data.validUntil,
                        messages: data.messages
                    });
                    showResult('–û—Ä–¥–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω! –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.', 'success');
                    console.log("Deposit transaction sent:", result);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(loadOrders, 5000);
                } catch (txError) {
                    console.error("Deposit transaction failed:", txError);
                    if (txError.message?.includes('rejected') || txError.message?.includes('declined')) {
                        showResult('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'error');
                    } else {
                        showResult('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + txError.message, 'error');
                    }
                }
            } catch (error) {
                console.error('Deposit error:', error);
                showResult('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
                // Range —Å–ª–∞–π–¥–µ—Ä—ã –¥–ª—è TP/SL
        function setupOrderSliders() {
            const orderType = document.getElementById('orderType');
            const entryPrice = document.getElementById('entryPrice');
            const stopLoss = document.getElementById('stopLoss');
            const takeProfit = document.getElementById('takeProfit');
               
            if (!stopLoss || !takeProfit || !orderType || !entryPrice) {
                console.warn('–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –æ—Ä–¥–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                return; // –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã null
            }
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
            const stopLossGroup = stopLoss.parentNode;
            const takeProfitGroup = takeProfit.parentNode;
            // –î–æ–±–∞–≤–ª—è–µ–º range —Å–ª–∞–π–¥–µ—Ä—ã
            stopLossGroup.innerHTML = `
                <label>Stop Loss (USDT):</label>
                <input type="range" id="stopLossRange" min="0" max="20" step="0.0001" class="slider">
                <input type="number" id="stopLoss" placeholder="7.0" step="0.0001" min="0.0001">
                <div class="slider-value" id="stopLossValue">7.0 USDT</div>
            `;
            takeProfitGroup.innerHTML = `
                <label>Take Profit (USDT):</label>
                <input type="range" id="takeProfitRange" min="0" max="20" step="0.0001" class="slider">
                <input type="number" id="takeProfit" placeholder="8.0" step="0.0001" min="0.0001">
                <div class="slider-value" id="takeProfitValue">8.0 USDT</div>
            `;
            const stopLossRange = document.getElementById('stopLossRange');
            const takeProfitRange = document.getElementById('takeProfitRange');
            const stopLossInput = document.getElementById('stopLoss');
            const takeProfitInput = document.getElementById('takeProfit');
            const stopLossValue = document.getElementById('stopLossValue');
            const takeProfitValue = document.getElementById('takeProfitValue');
            entryPrice.step = '0.0001';
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å–ª–∞–π–¥–µ—Ä–æ–≤
            function updateSliderLimits() {
                const type = orderType.value;
                const entry = parseFloat(entryPrice.value) || 0;
                if (entry > 0) {
                    const sliderStep = Math.max(0.0001, parseFloat((entry * 0.001).toFixed(4)));
                    stopLossRange.step = sliderStep;
                    takeProfitRange.step = sliderStep;
                    stopLossInput.step = '0.0001';
                    takeProfitInput.step = '0.0001';
                    if (type === 'long') {
                        // –î–ª—è LONG: SL <= Entry, TP >= Entry
                        stopLossRange.max = entry;
                        stopLossRange.min = Math.max(0, entry * 0.5); // –ú–∏–Ω–∏–º—É–º 50% –æ—Ç entry
                        takeProfitRange.min = entry;
                        takeProfitRange.max = entry * 2; // –ú–∞–∫—Å–∏–º—É–º 200% –æ—Ç entry
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—É–º–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (!stopLossInput.value) {
                            const slValue = (entry * 0.9).toFixed(4); // -10% –æ—Ç entry
                            stopLossRange.value = slValue;
                            stopLossInput.value = slValue;
                            stopLossValue.textContent = `${slValue} USDT`;
                        }
                        if (!takeProfitInput.value) {
                            const tpValue = (entry * 1.1).toFixed(4); // +10% –æ—Ç entry
                            takeProfitRange.value = tpValue;
                            takeProfitInput.value = tpValue;
                            takeProfitValue.textContent = `${tpValue} USDT`;
                        }
                    } else if (type === 'short') {
                        // –î–ª—è SHORT: SL >= Entry, TP <= Entry
                        stopLossRange.min = entry;
                        stopLossRange.max = entry * 2;
                        takeProfitRange.max = entry;
                        takeProfitRange.min = Math.max(0, entry * 0.5);
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—É–º–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (!stopLossInput.value) {
                            const slValue = (entry * 1.1).toFixed(4); // +10% –æ—Ç entry
                            stopLossRange.value = slValue;
                            stopLossInput.value = slValue;
                            stopLossValue.textContent = `${slValue} USDT`;
                        }
                        if (!takeProfitInput.value) {
                            const tpValue = (entry * 0.9).toFixed(4); // -10% –æ—Ç entry
                            takeProfitRange.value = tpValue;
                            takeProfitInput.value = tpValue;
                            takeProfitValue.textContent = `${tpValue} USDT`;
                        }
                    }
                }
            }
            // –°–≤—è–∑—ã–≤–∞–Ω–∏–µ range –∏ number inputs
            function setupSliderBinding(rangeEl, inputEl, valueEl) {
                rangeEl.addEventListener('input', function() {
                    inputEl.value = this.value;
                    valueEl.textContent = `${this.value} USDT`;
                });
                inputEl.addEventListener('input', function() {
                    let value = parseFloat(this.value) || 0;
                    const min = parseFloat(rangeEl.min);
                    const max = parseFloat(rangeEl.max);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–ª–∞–π–¥–µ—Ä–∞
                    value = Math.max(min, Math.min(max, value));
                    this.value = value.toFixed(4);
                    rangeEl.value = value.toFixed(4);
                    valueEl.textContent = `${value.toFixed(4)} USDT`;
                });
            }
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
            setupSliderBinding(stopLossRange, stopLossInput, stopLossValue);
            setupSliderBinding(takeProfitRange, takeProfitInput, takeProfitValue);
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞ –∏–ª–∏ —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
            orderType.addEventListener('change', updateSliderLimits);
            entryPrice.addEventListener('input', updateSliderLimits);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateSliderLimits();

            window.updateOrderSliderLimits = updateSliderLimits;
            window.setOrderDefaultsFromPrice = function(price) {
                if (!price || price <= 0) return;
                entryPrice.value = parseFloat(price).toFixed(4);
                const type = orderType.value;
                const slMultiplier = type === 'long' ? 0.9 : 1.1;
                const tpMultiplier = type === 'long' ? 1.1 : 0.9;
                stopLossInput.value = (price * slMultiplier).toFixed(4);
                takeProfitInput.value = (price * tpMultiplier).toFixed(4);
                stopLossRange.value = stopLossInput.value;
                takeProfitRange.value = takeProfitInput.value;
                stopLossValue.textContent = `${stopLossInput.value} USDT`;
                takeProfitValue.textContent = `${takeProfitInput.value} USDT`;
                updateSliderLimits();
            };
        }
        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç CSS
        const sliderStyles = `
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin: 10px 0;
        }
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0088cc;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0088cc;
            cursor: pointer;
            border: none;
        }
        .slider-value {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        `;
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç
        const styleSheet = document.createElement('style');
        styleSheet.textContent = sliderStyles;
        document.head.appendChild(styleSheet);
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∫–ª–∞–¥–æ–∫ —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤
        function setupOrderTypeTabs() {
            document.querySelectorAll('.order-type-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤
                    document.querySelectorAll('.order-type-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.order-tab-content').forEach(c => {
                        c.classList.remove('active');
                        c.style.display = 'none';
                    });
                
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    this.classList.add('active');
                    const orderType = this.dataset.orderType;
                    const targetId = orderType + '-order-form';
                    const target = document.getElementById(targetId);
                    if (target) {
                        target.classList.add('active');
                        target.style.display = 'block';
                    }
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∫–ª–∞–¥–æ–∫ —Ñ–æ—Ä–º –æ—Ä–¥–µ—Ä–æ–≤
        function setupOrderFormTabs() {
            document.querySelectorAll('[data-order-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('[data-order-tab]').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.order-tab-content').forEach(c => {
                        c.style.display = 'none';
                        c.classList.remove('active');
                    });
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    this.classList.add('active');
                    const tabId = this.dataset.orderTab;
                    const targetId = tabId === 'simple' ? 'simple-order-form' : 
                                   tabId === 'advanced' ? 'advanced-order-form' : 
                                   'oco-order-form';
                    const target = document.getElementById(targetId);
                    if (target) {
                        target.style.display = 'block';
                        target.classList.add('active');
                    }
                });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            setupOrderSliders();
            setupAdvancedOrderForm();
            setupOcoOrderForm();
            setupOrderFormTabs();
            setupOrderTypeTabs();
            if (latestMarketPrice && typeof window.setOrderDefaultsFromPrice === 'function' && !orderDefaultsInitialized) {
                window.setOrderDefaultsFromPrice(latestMarketPrice);
                orderDefaultsInitialized = true;
            }
        });
        

        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
        function setupAdvancedOrderForm() {
            const orderTypeSelect = document.getElementById('advancedOrderType');
            const enableTrailing = document.getElementById('enableTrailing');
            const trailingConfig = document.getElementById('trailingConfig');
            const slippageGroup = document.getElementById('slippageGroup');
            const stopPriceGroup = document.getElementById('stopPriceGroup');
            const limitPriceGroup = document.getElementById('limitPriceGroup');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞
            if (orderTypeSelect) {
                orderTypeSelect.addEventListener('change', function() {
                    const type = this.value;
                    
                    // –î–ª—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
                    if (type === 'MARKET') {
                        slippageGroup.style.display = 'block';
                        limitPriceGroup.style.display = 'block';
                        limitPriceGroup.querySelector('label').textContent = '–ú–∞–∫—Å. —Ü–µ–Ω–∞ (USDT):';
                    } else {
                        slippageGroup.style.display = 'none';
                    }
                    
                    // –î–ª—è —Å—Ç–æ–ø-–æ—Ä–¥–µ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–ø-—Ü–µ–Ω—É
                    if (type === 'STOP_ENTRY' || type === 'STOP_LOSS' || type === 'TAKE_PROFIT') {
                        stopPriceGroup.style.display = 'block';
                        limitPriceGroup.style.display = 'none';
                    } else if (type === 'LIMIT') {
                        stopPriceGroup.style.display = 'none';
                        limitPriceGroup.style.display = 'block';
                        limitPriceGroup.querySelector('label').textContent = '–õ–∏–º–∏—Ç–Ω–∞—è —Ü–µ–Ω–∞ (USDT):';
                    } else {
                        stopPriceGroup.style.display = 'none';
                    }
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç—Ä–µ–π–ª–∏–Ω–≥–∞
            if (enableTrailing) {
                enableTrailing.addEventListener('change', function() {
                    trailingConfig.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
            const form = document.getElementById('advancedOrderForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!currentWallet) {
                        showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                        return;
                    }
                    
                    const orderData = {
                        symbol: document.getElementById('advancedPair').value,
                        quantity: parseFloat(document.getElementById('advancedQuantity').value),
                        order_type: document.getElementById('advancedOrderType').value,
                        side: document.getElementById('advancedSide').value,
                        user_wallet: currentWallet.address,
                        limit_price: document.getElementById('limitPrice').value ? parseFloat(document.getElementById('limitPrice').value) : null,
                        stop_price: document.getElementById('stopPrice').value ? parseFloat(document.getElementById('stopPrice').value) : null,
                        entry_price: document.getElementById('advancedEntryPrice').value ? parseFloat(document.getElementById('advancedEntryPrice').value) : null,
                        stop_loss: document.getElementById('advancedStopLoss').value ? parseFloat(document.getElementById('advancedStopLoss').value) : null,
                        take_profit: document.getElementById('advancedTakeProfit').value ? parseFloat(document.getElementById('advancedTakeProfit').value) : null,
                        max_slippage: document.getElementById('maxSlippage').value ? parseFloat(document.getElementById('maxSlippage').value) : 0.5
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
                    if (enableTrailing && enableTrailing.checked) {
                        orderData.trailing_type = document.getElementById('trailingType').value;
                        orderData.trailing_distance = parseFloat(document.getElementById('trailingDistance').value);
                    }
                    
                    try {
                        const res = await fetch('/api/orders/create', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(orderData)
                        });
                        
                        const data = await res.json();
                        
                        if (data.success) {
                            let msg = `–û—Ä–¥–µ—Ä ${data.order.id} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`;
                            if (data.gas_info) {
                                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∞–∑–µ
                                msg += `<br><small>–ì–∞–∑: ${data.gas_info.gas_amount.toFixed(6)} TON, –í—Å–µ–≥–æ: ${data.gas_info.total_amount.toFixed(6)} TON</small>`;
                            }
                            showResult(msg, 'success');
                            form.reset();
                            loadOrders();
                        } else {
                            showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                        }
                    } catch (error) {
                        console.error('Create advanced order error:', error);
                        showResult('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞', 'error');
                    }
                });
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OCO —Ñ–æ—Ä–º—ã
        function setupOcoOrderForm() {
            const form = document.getElementById('ocoOrderForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!currentWallet) {
                        showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                        return;
                    }
                    
                    const side = document.getElementById('ocoSide').value;
                    const pair = document.getElementById('ocoPair').value;
                    const quantity = parseFloat(document.getElementById('ocoQuantity').value);
                    const entryPrice = parseFloat(document.getElementById('ocoEntryPrice').value);
                    const tpPrice = parseFloat(document.getElementById('ocoTakeProfit').value);
                    const slPrice = parseFloat(document.getElementById('ocoStopLoss').value);
                    
                    const ocoData = {
                        tp_order: {
                            symbol: pair,
                            quantity: quantity,
                            side: side,
                            take_profit: tpPrice,
                            entry_price: entryPrice
                        },
                        sl_order: {
                            symbol: pair,
                            quantity: quantity,
                            side: side,
                            stop_loss: slPrice,
                            entry_price: entryPrice
                        }
                    };
                    
                    try {
                        const res = await fetch('/api/orders/oco', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(ocoData)
                        });
                        
                        const data = await res.json();
                        
                        if (data.success) {
                            let msg = `OCO –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω! –ì—Ä—É–ø–ø–∞: ${data.oco_group_id}`;
                            if (data.gas_info) {
                                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∞–∑–µ
                                msg += `<br><small>–ì–∞–∑: ${data.gas_info.gas_amount.toFixed(6)} TON, –í—Å–µ–≥–æ: ${data.gas_info.total_amount.toFixed(6)} TON</small>`;
                            }
                            showResult(msg, 'success');
                            form.reset();
                            loadOrders();
                        } else {
                            showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                        }
                    } catch (error) {
                        console.error('Create OCO order error:', error);
                        showResult('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è OCO –æ—Ä–¥–µ—Ä–∞', 'error');
                    }
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
        async function setTrailingStop(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showResult('–û—Ä–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            const trailingType = prompt('–¢–∏–ø —Ç—Ä–µ–π–ª–∏–Ω–≥–∞:\n1 - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–ø—É–Ω–∫—Ç—ã)\n2 - –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π', '1');
            if (!trailingType) return;
            
            const distance = prompt('–î–∏—Å—Ç–∞–Ω—Ü–∏—è:', '5.0');
            if (!distance) return;
            
            try {
                const res = await fetch(`/api/orders/${orderId}/trailing`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        trailing_type: trailingType === '1' ? 'FIXED' : 'PERCENTAGE',
                        trailing_distance: parseFloat(distance)
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showResult('–¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!', 'success');
                    loadOrders();
                } else {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Set trailing stop error:', error);
                showResult('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞', 'error');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞
        const originalRenderOrders = window.renderOrders;
        if (originalRenderOrders) {
            window.renderOrders = function() {
                originalRenderOrders();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
                setTimeout(() => {
                    const activeBody = document.getElementById('activeOrdersBody');
                    if (activeBody) {
                        activeBody.querySelectorAll('tr').forEach(row => {
                            const buttons = row.querySelectorAll('button');
                            if (buttons.length > 0) {
                                const orderId = buttons[0].onclick?.toString().match(/'([^']+)'/)?.[1] ||
                                             buttons[0].getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                                if (orderId) {
                                    const order = orders.find(o => o.id === orderId);
                                    if (order && !order.trailing_type && 
                                        (order.status === 'opened' || order.status === 'waiting_entry' || order.status === 'active')) {
                                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                                        const actionsCell = row.querySelector('.order-actions');
                                        if (actionsCell && !actionsCell.querySelector('.trailing-btn')) {
                                            const trailingBtn = document.createElement('button');
                                            trailingBtn.className = 'trailing-btn';
                                            trailingBtn.style.cssText = 'background: #ff9800; color: white; padding: 5px 10px; font-size: 0.8em; width: auto; margin-right: 5px;';
                                            trailingBtn.textContent = 'Trailing';
                                            trailingBtn.onclick = () => setTrailingStop(orderId);
                                            actionsCell.insertBefore(trailingBtn, actionsCell.firstChild);
                                        }
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            };
        }
    </script>
</body>
</html>