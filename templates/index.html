<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON –û–±–º–µ–Ω–Ω–∏–∫ & –û—Ä–¥–µ—Ä–∞</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #0088cc; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #006699; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #wallet { margin: 15px 0; padding: 15px; background: #e8f5e8; border-radius: 5px; border: 1px solid #4caf50; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .loading { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .hidden { display: none; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .balance { color: #666; font-size: 0.9em; }
        .slippage-control { display: flex; gap: 10px; margin: 10px 0; }
        .slippage-btn { flex: 1; padding: 8px; text-align: center; background: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .slippage-btn.active { background: #0088cc; color: white; border-color: #0088cc; }
        .slippage-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        .quote-info { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #0088cc; }
        .min-received { color: #666; font-size: 0.9em; margin-top: 5px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤ */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #0088cc; color: white; border-color: #ddd; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .order-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .order-form .full-width { grid-column: 1 / -1; }
        
        .orders-list { margin-top: 20px; }
        .order-item { padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .order-item.long { border-left: 4px solid #4caf50; }
        .order-item.short { border-left: 4px solid #f44336; }
        .order-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .order-type { font-weight: bold; padding: 2px 8px; border-radius: 3px; color: white; }
        .order-type.long { background: #4caf50; }
        .order-type.short { background: #f44336; }
        .order-status { padding: 2px 8px; border-radius: 3px; font-size: 0.8em; }
        .order-status.active { background: #ff9800; color: white; }
        .order-status.executed { background: #4caf50; color: white; }
        .order-status.cancelled { background: #9e9e9e; color: white; }
        .order-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; }
        .order-actions { margin-top: 10px; text-align: right; }
        .cancel-btn { background: #f44336; padding: 5px 10px; font-size: 0.8em; width: auto; }
        
        .wallet-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em; }
        .deposit-btn {
            background: #4caf50;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            margin-right: 5px;
        }

        .deposit-btn:hover {
            background: #45a049;
        }

        .order-actions {
            margin-top: 10px;
            text-align: right;
        }

        .cancel-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
        }

        .edit-btn {
            background: #ff9800;
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            margin-right: 5px;
        }
.edit-btn:hover {
    background: #e65100;
}
.cancel-btn:hover {
    background: #d32f2f;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ TON –û–±–º–µ–Ω–Ω–∏–∫ & –¢–æ—Ä–≥–æ–≤—ã–µ –û—Ä–¥–µ—Ä–∞</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="swap">üîÑ –û–±–º–µ–Ω</div>
            <div class="tab" data-tab="orders">üìä –û—Ä–¥–µ—Ä–∞</div>
            <div class="tab" data-tab="wallet">üëõ –ö–æ—à–µ–ª–µ–∫ –æ—Ä–¥–µ—Ä–æ–≤</div>
        </div>
        
        <div id="wallet" class="hidden"></div>
        <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>

        <!-- –í–∫–ª–∞–¥–∫–∞ –æ–±–º–µ–Ω–∞ -->
        <div class="tab-content active" id="swap-tab">
            <form id="swapForm" class="hidden">
                <div class="form-group">
                    <label>–û—Ç–¥–∞–µ—Ç–µ:</label>
                    <select id="fromToken">
                        <option value="TON">TON</option>
                        <option value="USDT">USDT</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–ü–æ–ª—É—á–∞–µ—Ç–µ:</label>
                    <select id="toToken">
                        <option value="USDT">USDT</option>
                        <option value="TON">TON</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–°—É–º–º–∞:</label>
                    <input type="number" id="amount" placeholder="0.0" step="0.01" min="0">
                    <div id="balance" class="balance"></div>
                </div>

                <div class="form-group">
                    <label>–î–æ–ø—É—Å–∫ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è (Slippage):</label>
                    <div class="slippage-control">
                        <div class="slippage-btn" data-slippage="0.5">0.5%</div>
                        <div class="slippage-btn active" data-slippage="1.0">1.0%</div>
                        <div class="slippage-btn" data-slippage="2.0">2.0%</div>
                        <div class="slippage-btn" data-slippage="3.0">3.0%</div>
                        <input type="number" id="customSlippage" class="slippage-input" placeholder="Custom" min="0.1" max="50" step="0.1">
                    </div>
                    <div class="balance">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±—É–¥–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç</div>
                </div>
                
                <button type="button" id="getQuote">üìä –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å</button>
                <div id="quote"></div>
                <button type="submit" id="swapBtn">üîÑ –û–±–º–µ–Ω—è—Ç—å</button>
            </form>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ -->
        <div class="tab-content" id="orders-tab">
            <div class="hidden" id="ordersAuth">
                <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Ä–¥–µ—Ä–∞–º–∏</p>
            </div>

            <div class="hidden" id="ordersInterface">
                <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ä–¥–µ—Ä</h3>
                <form id="orderForm">
                    <div class="order-form">
                        <div class="form-group">
                            <label>–¢–∏–ø –æ—Ä–¥–µ—Ä–∞:</label>
                            <select id="orderType" required>
                                <option value="long">LONG (–ü–æ–∫—É–ø–∫–∞)</option>
                                <option value="short">SHORT (–ü—Ä–æ–¥–∞–∂–∞)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>–ü–∞—Ä–∞:</label>
                            <select id="orderPair" required>
                                <option value="TON-USDT">TON-USDT</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>–°—É–º–º–∞ (TON):</label>
                            <input type="number" id="orderAmount" placeholder="0.0" step="0.01" min="0.1" required>
                        </div>
                        
                        <div class="form-group">
                            <label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞ (USDT):</label>
                            <input type="number" id="entryPrice" placeholder="7.5" step="0.01" min="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Stop Loss (USDT):</label>
                            <input type="number" id="stopLoss" placeholder="7.0" step="0.01" min="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>Take Profit (USDT):</label>
                            <input type="number" id="takeProfit" placeholder="8.0" step="0.01" min="0.01">
                        </div>
                    </div>
                    
                    <button type="submit" id="createOrderBtn">üìà –°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä</button>
                </form>

                <div class="orders-list">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞</h3>
                    <div id="activeOrders"></div>
                    
                    <h3>–ò—Å—Ç–æ—Ä–∏—è –æ—Ä–¥–µ—Ä–æ–≤</h3>
                    <div id="orderHistory"></div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ -->
        <div class="tab-content" id="wallet-tab">
            <div class="wallet-info">
                <h3>üëõ –ö–æ—à–µ–ª–µ–∫ –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤</h3>
                <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="orderWalletAddress">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="orderWalletBalance">0</span> TON</p>
                <p class="balance">–≠—Ç–æ—Ç –∫–æ—à–µ–ª–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –æ—Ä–¥–µ—Ä–æ–≤. –ú–Ω–µ–º–æ–Ω–∏–∫–∞ —É–∂–µ –≤–Ω–µ—Å–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
            </div>
            
            <div class="form-group">
                <h4>–î–µ–ø–æ–∑–∏—Ç –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤</h4>
                <p>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ TON –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤—ã—à–µ –∞–¥—Ä–µ—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤</p>
            </div>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let currentWallet = null;
        let tonConnectUI = null;
        let currentSlippage = 1.0;
        let orders = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
        function initTonConnect() {
            const manifestUrl = "https://raw.githubusercontent.com/Qazqazqaz2/cucaracha_2/main/tonconnect-manifest.json";
            
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: manifestUrl,
                buttonRootId: 'connectBtn'
            });

            tonConnectUI.connectionRestored.then(() => {
                checkConnection();
            });

            tonConnectUI.onStatusChange(wallet => {
                currentWallet = wallet;
                checkConnection();
            });
        }
        
        function checkConnection() {
            const wallet = tonConnectUI.account;
            if (wallet) {
                currentWallet = wallet;
                const shortAddress = wallet.address.slice(0, 8) + '...' + wallet.address.slice(-8);
                document.getElementById('wallet').innerHTML = `‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω: ${shortAddress}`;
                document.getElementById('wallet').classList.remove('hidden');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('swapForm').classList.remove('hidden');
                document.getElementById('ordersInterface').classList.remove('hidden');
                document.getElementById('ordersAuth').classList.add('hidden');
                updateBalance();
                loadOrders();
                loadOrderWalletInfo();
            } else {
                document.getElementById('wallet').classList.add('hidden');
                document.getElementById('connectBtn').classList.remove('hidden');
                document.getElementById('swapForm').classList.add('hidden');
                document.getElementById('ordersInterface').classList.add('hidden');
                document.getElementById('ordersAuth').classList.remove('hidden');
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab + '-tab';
                    document.getElementById(tabId).classList.add('active');
                    
                    // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –æ—Ä–¥–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    if (tab.dataset.tab === 'orders') {
                        loadOrders();
                    }
                });
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ slippage
        function setupSlippageControls() {
            const buttons = document.querySelectorAll('.slippage-btn');
            const customInput = document.getElementById('customSlippage');
            
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSlippage = parseFloat(btn.dataset.slippage);
                    customInput.value = '';
                });
            });
            
            customInput.addEventListener('input', () => {
                if (customInput.value) {
                    buttons.forEach(b => b.classList.remove('active'));
                    currentSlippage = parseFloat(customInput.value);
                }
            });
            
            customInput.addEventListener('blur', () => {
                if (customInput.value) {
                    let value = parseFloat(customInput.value);
                    if (value < 0.1) value = 0.1;
                    if (value > 50) value = 50;
                    currentSlippage = value;
                    customInput.value = value;
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—à–µ–ª—å–∫–µ –æ—Ä–¥–µ—Ä–æ–≤
        async function loadOrderWalletInfo() {
            try {
                const res = await fetch('/order-wallet');
                const data = await res.json();
                
                if (data.address) {
                    document.getElementById('orderWalletAddress').textContent = data.address;
                    document.getElementById('orderWalletBalance').textContent = data.balance.toFixed(4);
                }
            } catch (error) {
                console.error('Order wallet info error:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤
        async function loadOrders() {
            if (!currentWallet) return;
            
            try {
                const res = await fetch('/orders');
                const data = await res.json();
                orders = data.orders || [];
                displayOrders();
            } catch (error) {
                console.error('Load orders error:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
        async function displayOrders() {
            const activeOrdersDiv = document.getElementById('activeOrders');
            const historyDiv = document.getElementById('orderHistory');
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –¥–ª—è –ø–∞—Ä:
            let prices = {};
            try {
                const res = await fetch('/quote', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({from_token: 'TON', to_token: 'USDT', amount: 1, slippage: 1})
                });
                const d = await res.json();
                prices['TON-USDT'] = d.quote;
            } catch {_=>{}}
            const userOrders = orders.filter(order => order.user_wallet === currentWallet.address);
            const activeOrders = userOrders.filter(order => order.status !== 'executed' && order.status !== 'cancelled');
            const historyOrders = userOrders.filter(order => order.status === 'executed' || order.status === 'cancelled');
            function renderOrder(order) {
                let currentPrice = prices[order.pair] || order.entry_price;
                const pnl = calculatePnL(order, currentPrice);
                const comms = calculateComms(order);
                        
                return `
                    <div class="order-item ${order.type}">
                        <div class="order-header">
                            <span class="order-type ${order.type}">${order.type.toUpperCase()}</span>
                            <span class="order-status ${order.status}">${getStatusText(order.status)}</span>
                        </div>
                        <div class="order-details">
                            <div><strong>–ü–∞—Ä–∞:</strong> ${order.pair}</div>
                            <div><strong>–°—É–º–º–∞:</strong> ${order.amount} TON</div>
                            <div><strong>–í—Ö–æ–¥:</strong> ${order.entry_price} USDT</div>
                            <div><strong>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å:</strong> ${(+currentPrice).toFixed(4)} USDT</div>
                            <div><strong>Stop Loss:</strong> ${order.stop_loss || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</div>
                            <div><strong>Take Profit:</strong> ${order.take_profit || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</div>
                            <div><strong>–ü–æ—Ç–µ–Ω—Ü. –ü—Ä–æ—Ñ–∏—Ç:</strong> <span style='color:${pnl>0?'#4caf50':'#f44336'}'>${pnl.toFixed(3)} USDT</span></div>
                            <div><strong>–ö–æ–º–∏—Å—Å–∏—è:</strong> ${comms.toFixed(4)} TON</div>
                            <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(order.created_at).toLocaleString()}</div>
                        </div>

                        <!-- –í–°–¢–ê–í–õ–Ø–ï–ú –ó–î–ï–°–¨ –ë–õ–û–ö –° –ö–ù–û–ü–ö–ê–ú–ò -->
                        <div class="order-actions">
                            ${order.status === 'unfunded' ? 
                                `<button class="deposit-btn" onclick="depositOrder('${order.id}')">üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä</button>` 
                                : ''}
                            ${['active','unfunded'].includes(order.status) ? 
                                `<button class="edit-btn" data-order='${JSON.stringify(order)}'>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` 
                                : ''}
                            <button class="cancel-btn" onclick="cancelOrder('${order.id}')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }
            activeOrdersDiv.innerHTML = activeOrders.length ? activeOrders.map(renderOrder).join('') : '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤</p>';
            historyDiv.innerHTML = historyOrders.length ? historyOrders.map(renderOrder).join('') : '<p>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ä–¥–µ—Ä–æ–≤</p>';
            bindEditBtns();
        }

        // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è unfunded
        function getStatusText(status) {
            const statusMap = {
                'unfunded': '–û–∂–∏–¥–∞–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è',
                'active': '–ê–∫—Ç–∏–≤–µ–Ω',
                'executed': '–ò—Å–ø–æ–ª–Ω–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω—ë–Ω'
            };
            return statusMap[status] || status;
        }
        // –í—Å—Ç–∞–≤–∏–º —Ä–∞—Å—á–µ—Ç PnL/–∫–æ–º–∏—Å—Å–∏–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞ –∏ entry_price) –∏ —Ä–∞—Å—à–∏—Ä–∏–º—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–µ—Ç–∞–ª–µ–π:
        function calculatePnL(order, currentPrice) {
            // PNL = (—Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å - entry) * amount –¥–ª—è LONG, –Ω–∞–æ–±–æ—Ä–æ—Ç –¥–ª—è SHORT
            if (!order.entry_price || !order.amount) return 0;
            if (!currentPrice) return 0;
            let pnl = 0;
            if (order.type === 'long') {
                pnl = (currentPrice - order.entry_price) * order.amount;
            } else {
                pnl = (order.entry_price - currentPrice) * order.amount;
            }
            return pnl;
        }
        function calculateComms(order) {
            // –û–±—â–∞—è –∫–æ–º–∏—Å—Å–∏—è = service_fee + pool_fee
            // 0.0025 + 0.003 = 0.0055 (0.55%) –æ—Ç —Å—É–º–º—ã
            return order.amount ? order.amount * 0.0055 : 0;
        }

        // –û—Ç–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞
        async function cancelOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä?')) return;
            
            try {
                const res = await fetch(`/orders/${orderId}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showResult('–û—Ä–¥–µ—Ä –æ—Ç–º–µ–Ω–µ–Ω', 'success');
                    loadOrders();
                } else {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                showResult('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞', 'error');
            }
        }

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                await tonConnectUI.openModal();
            } catch (error) {
                console.error('Connection error:', error);
                showResult('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            }
        });

        async function updateBalance() {
            if (!currentWallet) return;
            
            const walletAddr = currentWallet.address;
            const fromToken = document.getElementById('fromToken').value;
            
            try {
                const res = await fetch('/balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({wallet_address: walletAddr, token: fromToken})
                });
                const data = await res.json();
                
                const balanceDiv = document.getElementById('balance');
                if (data.error) {
                    balanceDiv.innerHTML = `–û—à–∏–±–∫–∞: ${data.error}`;
                } else {
                    balanceDiv.innerHTML = `–ë–∞–ª–∞–Ω—Å: ${data.balance.toFixed(4)} ${fromToken}`;
                }
            } catch (error) {
                console.error('Balance error:', error);
            }
        }

        document.getElementById('getQuote').addEventListener('click', async () => {
            const fromToken = document.getElementById('fromToken').value;
            const toToken = document.getElementById('toToken').value;
            const amount = document.getElementById('amount').value;

            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–±–º–µ–Ω–∞', 'error');
                return;
            }

            try {
                const res = await fetch('/quote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        from_token: fromToken, 
                        to_token: toToken, 
                        amount: amount,
                        slippage: currentSlippage
                    })
                });
                const data = await res.json();
                
                const quoteDiv = document.getElementById('quote');
                if (data.error) {
                    quoteDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                } else {
                    quoteDiv.innerHTML = `
                        <div class="quote-info">
                            <strong>–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ${data.formatted}</strong>
                            <div class="min-received">–ú–∏–Ω–∏–º—É–º: ${data.min_output_formatted} (slippage: ${data.slippage}%)</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Quote error:', error);
                showResult('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞', 'error');
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
            
            const orderType = document.getElementById('orderType').value;
            const pair = document.getElementById('orderPair').value;
            const amount = document.getElementById('orderAmount').value;
            const entryPrice = document.getElementById('entryPrice').value;
            const stopLoss = document.getElementById('stopLoss').value;
            const takeProfit = document.getElementById('takeProfit').value;
            
            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ä–¥–µ—Ä–∞', 'error');
                return;
            }
            
            if (!entryPrice || entryPrice <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞', 'error');
                return;
            }

            try {
                const res = await fetch('/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: orderType,
                        pair: pair,
                        amount: parseFloat(amount),
                        entry_price: parseFloat(entryPrice),
                        stop_loss: stopLoss || null,
                        take_profit: takeProfit || null,
                        user_wallet: currentWallet.address
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    let msg = `–û—Ä–¥–µ—Ä ${orderType.toUpperCase()} —Å–æ–∑–¥–∞–Ω!`;
                    if (data.order.status === 'unfunded') {
                        msg += `<br><b>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <span style='color:#0088cc'>${data.order.amount} TON</span> –Ω–∞ <span style='color:#006699'>${data.order.order_wallet}</span> –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!</b>`;
                    }
                    showResult(msg, 'success');
                    document.getElementById('orderForm').reset();
                    loadOrders();
                } else {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Create order error:', error);
                showResult('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞', 'error');
            }
        });

        document.getElementById('swapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
        
            const fromToken = document.getElementById('fromToken').value;
            const toToken = document.getElementById('toToken').value;
            const amount = document.getElementById('amount').value;
        
            if (!amount || amount <= 0) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –æ–±–º–µ–Ω–∞', 'error');
                return;
            }
        
            try {
                showResult('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...', 'loading');
                
                const res = await fetch('/swap', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        wallet_address: currentWallet.address,
                        from_token: fromToken,
                        to_token: toToken,
                        amount: amount,
                        slippage: currentSlippage
                    })
                });
                const data = await res.json();
                
                if (data.error) {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                    return;
                }
            
                showResult('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –∫–æ—à–µ–ª—å–∫–µ...', 'loading');
                
                let message;
                if (data.messages && Array.isArray(data.messages)) {
                    message = data.messages[0];
                } else {
                    message = {
                        address: data.to_address,
                        amount: data.amount,
                        payload: data.payload
                    };
                }
            
                const transaction = {
                    validUntil: data.validUntil || Math.floor(Date.now() / 1000) + 300,
                    messages: [message]
                };
            
                try {
                    const result = await tonConnectUI.sendTransaction(transaction);
                    showResult('–°–≤–æ–ø –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    console.log("Transaction sent:", result);
                    
                    setTimeout(updateBalance, 3000);
                } catch (txError) {
                    console.error("Transaction failed:", txError);
                    if (txError.message?.includes('rejected') || txError.message?.includes('declined')) {
                        showResult('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'error');
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + txError.message, 'error');
                    }
                }
            
            } catch (error) {
                console.error('Swap error:', error);
                showResult('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
    
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = type ? (type === 'success' ? 'success' : type === 'loading' ? 'loading' : 'error') : '';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–æ–∫–µ–Ω–∞
        document.getElementById('fromToken').addEventListener('change', updateBalance);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initTonConnect();
        setupSlippageControls();
        setupTabs();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentWallet) {
                loadOrders();
                loadOrderWalletInfo();
            }
        }, 30000);

        function bindEditBtns() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = () => {
                    const order = JSON.parse(btn.dataset.order);
                    showEditModal(order);
                }
            });
        }
        window.showEditModal = function(order) {
            if (document.getElementById('orderEditModal')) document.getElementById('orderEditModal').remove();
            const modal = document.createElement('div');
            modal.id = 'orderEditModal';
            modal.style = 'position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `<div style='background:white;padding:30px 20px;border-radius:8px;min-width:320px;max-width:95vw'>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–¥–µ—Ä (${order.id})</h3>
            <form id='editOrderForm'>
              <label>–°—É–º–º–∞ TON:<input type='number' name='amount' value='${order.amount}' step='0.01' required></label><br><label>Stop Loss:<input type='number' name='stop_loss' value='${order.stop_loss || ''}' step='0.01'></label><br><label>Take Profit:<input type='number' name='take_profit' value='${order.take_profit || ''}' step='0.01'></label><br><button type='submit'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button type='button' onclick='document.getElementById("orderEditModal").remove()'>–û—Ç–º–µ–Ω–∞</button>
            </form>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('editOrderForm').onsubmit = async (e) => {
              e.preventDefault();
              const f = e.target;
              const patch = {
                amount: parseFloat(f.amount.value),
                stop_loss: f.stop_loss.value ? parseFloat(f.stop_loss.value) : null,
                take_profit: f.take_profit.value ? parseFloat(f.take_profit.value) : null
              };
              try {
                const res = await fetch(`/orders/${order.id}`, {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(patch)});
                const data = await res.json();
                if (data.success) {
                  showResult('–û—Ä–¥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
                  document.getElementById('orderEditModal').remove();
                  loadOrders();
                } else {
                  showResult('–û—à–∏–±–∫–∞: '+data.error,'error');
                }
              } catch(e){
                showResult('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏','error');
              }
            }
        }
        async function depositOrder(orderId) {
            if (!currentWallet) {
                showResult('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫', 'error');
                return;
            }
        
            try {
                showResult('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è...', 'loading');

                const res = await fetch('/deposit-order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        order_id: orderId
                    })
                });

                const data = await res.json();

                if (data.error) {
                    showResult('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                    return;
                }

                showResult('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –∫–æ—à–µ–ª—å–∫–µ...', 'loading');

                try {
                    const result = await tonConnectUI.sendTransaction({
                        validUntil: data.validUntil,
                        messages: data.messages
                    });

                    showResult('–û—Ä–¥–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω! –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.', 'success');
                    console.log("Deposit transaction sent:", result);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(loadOrders, 5000);

                } catch (txError) {
                    console.error("Deposit transaction failed:", txError);
                    if (txError.message?.includes('rejected') || txError.message?.includes('declined')) {
                        showResult('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'error');
                    } else {
                        showResult('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + txError.message, 'error');
                    }
                }

            } catch (error) {
                console.error('Deposit error:', error);
                showResult('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
